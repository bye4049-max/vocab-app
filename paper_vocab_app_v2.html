<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë…¼ë¬¸ ë‹¨ì–´ í•™ìŠµ ì•± (êµ¬ê¸€ ë“œë¼ì´ë¸Œ ë™ê¸°í™”)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: #2563eb;
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .sync-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
            font-size: 14px;
        }

        .sync-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
        }

        .sync-indicator.syncing {
            background: #f59e0b;
            animation: pulse 1.5s infinite;
        }

        .sync-indicator.offline {
            background: #6c757d;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .login-screen {
            padding: 60px 30px;
            text-align: center;
        }

        .login-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .login-screen h2 {
            color: #333;
            margin-bottom: 15px;
        }

        .login-screen p {
            color: #6c757d;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            background: none;
            border: none;
            font-size: 16px;
            color: #6c757d;
            transition: all 0.3s;
        }

        .tab.active {
            background: white;
            color: #2563eb;
            font-weight: 600;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .content {
            padding: 30px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        input[type="text"],
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        textarea:focus {
            outline: none;
            border-color: #2563eb;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            background: #2563eb;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #1d4ed8;
        }

        .btn:disabled {
            background: #cbd5e1;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-google {
            background: white;
            color: #333;
            border: 2px solid #e9ecef;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .btn-google:hover {
            background: #f8f9fa;
            border-color: #cbd5e1;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 14px;
        }

        .item-list {
            margin-top: 20px;
        }

        .item {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 12px;
            border-radius: 8px;
            border-left: 4px solid #2563eb;
        }

        .item-sentence {
            font-size: 16px;
            margin-bottom: 8px;
            color: #333;
        }

        .item-word {
            display: inline-block;
            background: #2563eb;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
            margin-right: 8px;
        }

        .item-actions {
            margin-top: 12px;
            display: flex;
            gap: 8px;
        }

        .test-card {
            background: white;
            border: 2px solid #e9ecef;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .test-sentence {
            font-size: 18px;
            line-height: 1.8;
            margin-bottom: 20px;
            color: #333;
        }

        .blank {
            display: inline-block;
            min-width: 150px;
            border-bottom: 2px solid #2563eb;
            text-align: center;
        }

        .answer-input {
            display: inline-block;
            min-width: 150px;
            padding: 4px 8px;
            border: 2px solid #2563eb;
            border-radius: 4px;
            background: #fff;
        }

        .result {
            margin-top: 20px;
            padding: 20px;
            border-radius: 8px;
        }

        .result.correct {
            background: #d4edda;
            border: 2px solid #28a745;
        }

        .result.incorrect {
            background: #f8d7da;
            border: 2px solid #dc3545;
        }

        .result-title {
            font-weight: 600;
            font-size: 18px;
            margin-bottom: 12px;
        }

        .result.correct .result-title {
            color: #28a745;
        }

        .result.incorrect .result-title {
            color: #dc3545;
        }

        .meaning {
            margin: 10px 0;
            padding: 12px;
            background: white;
            border-radius: 6px;
        }

        .meaning-label {
            font-weight: 600;
            color: #666;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .meaning-text {
            color: #333;
            font-size: 15px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-number {
            font-size: 32px;
            font-weight: 700;
            color: #2563eb;
        }

        .stat-label {
            font-size: 14px;
            color: #6c757d;
            margin-top: 5px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .test-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
        }

        .test-progress {
            color: #6c757d;
            font-size: 14px;
        }

        .user-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
        }

        .user-name {
            font-size: 14px;
            color: #333;
            font-weight: 500;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-info {
            background: #cfe2ff;
            color: #084298;
            border: 1px solid #b6d4fe;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #2563eb;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“š ë…¼ë¬¸ ë‹¨ì–´ í•™ìŠµ</h1>
            <p>êµ¬ê¸€ ë“œë¼ì´ë¸Œë¡œ ëª¨ë“  ê¸°ê¸°ì—ì„œ ë™ê¸°í™”</p>
            <div class="sync-status" id="syncStatus">
                <span class="sync-indicator offline"></span>
                <span id="syncText">ì˜¤í”„ë¼ì¸</span>
            </div>
        </div>

        <div id="loginScreen" class="login-screen">
            <div class="login-icon">ğŸ”</div>
            <h2>êµ¬ê¸€ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸</h2>
            <p>
                êµ¬ê¸€ ë“œë¼ì´ë¸Œë¥¼ ì‚¬ìš©í•˜ì—¬ ëª¨ë“  ê¸°ê¸°ì—ì„œ<br>
                í•™ìŠµ ë°ì´í„°ë¥¼ ë™ê¸°í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br><br>
                <strong>ì•ˆì „í•©ë‹ˆë‹¤:</strong> ë°ì´í„°ëŠ” ì—¬ëŸ¬ë¶„ì˜ êµ¬ê¸€ ë“œë¼ì´ë¸Œì—ë§Œ ì €ì¥ë˜ë©°,<br>
                ì´ ì•± ì „ìš© í´ë”ì—ë§Œ ì ‘ê·¼í•©ë‹ˆë‹¤.
            </p>
            <button class="btn btn-google" onclick="handleAuthClick()" id="loginButton" disabled>
                <span class="loading"></span>
                ë¡œë”© ì¤‘...
            </button>
            
            <div class="alert alert-info" style="margin-top: 30px; text-align: left;">
                <span>â„¹ï¸</span>
                <div style="font-size: 14px;">
                    <strong>ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤:</strong><br>
                    ì´ ì•±ì„ ì‚¬ìš©í•˜ë ¤ë©´ êµ¬ê¸€ í´ë¼ìš°ë“œì—ì„œ API í‚¤ë¥¼ ë°œê¸‰ë°›ì•„ì•¼ í•©ë‹ˆë‹¤.<br>
                    ì•„ë˜ íŒŒì¼ì— ìì„¸í•œ ì„¤ëª…ì´ ìˆìŠµë‹ˆë‹¤.
                </div>
            </div>
        </div>

        <div id="mainApp" style="display: none;">
            <div class="user-info">
                <div class="user-profile">
                    <img id="userAvatar" class="user-avatar" src="" alt="í”„ë¡œí•„">
                    <span id="userName" class="user-name"></span>
                </div>
                <button class="btn btn-secondary btn-small" onclick="handleSignoutClick()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="switchTab('add')">ì¶”ê°€í•˜ê¸°</button>
                <button class="tab" onclick="switchTab('list')">ëª©ë¡ë³´ê¸°</button>
                <button class="tab" onclick="switchTab('test')">í…ŒìŠ¤íŠ¸</button>
                <button class="tab" onclick="switchTab('stats')">í•™ìŠµê¸°ë¡</button>
            </div>

            <div class="content">
                <!-- ì¶”ê°€í•˜ê¸° íƒ­ -->
                <div id="add" class="tab-content active">
                    <h2 style="margin-bottom: 20px;">ìƒˆ ë¬¸ì¥ ì¶”ê°€</h2>
                    <form onsubmit="addItem(event)">
                        <div class="form-group">
                            <label>ë…¼ë¬¸ ë¬¸ì¥ (ì˜ì–´)</label>
                            <textarea id="sentence" placeholder="ì˜ˆ: Photosynthesis is the process by which plants convert light energy into chemical energy." required></textarea>
                        </div>
                        <div class="form-group">
                            <label>ì™¸ìš¸ ë‹¨ì–´</label>
                            <input type="text" id="word" placeholder="ì˜ˆ: photosynthesis" required>
                        </div>
                        <div class="form-group">
                            <label>ë¬¸ì¥ ëœ» (í•œê¸€)</label>
                            <textarea id="sentenceMeaning" placeholder="ì˜ˆ: ê´‘í•©ì„±ì€ ì‹ë¬¼ì´ ë¹› ì—ë„ˆì§€ë¥¼ í™”í•™ ì—ë„ˆì§€ë¡œ ë³€í™˜í•˜ëŠ” ê³¼ì •ì´ë‹¤." required></textarea>
                        </div>
                        <div class="form-group">
                            <label>ë‹¨ì–´ ëœ» (í•œê¸€)</label>
                            <input type="text" id="wordMeaning" placeholder="ì˜ˆ: ê´‘í•©ì„±" required>
                        </div>
                        <button type="submit" class="btn">ì €ì¥í•˜ê¸°</button>
                    </form>
                </div>

                <!-- ëª©ë¡ë³´ê¸° íƒ­ -->
                <div id="list" class="tab-content">
                    <h2 style="margin-bottom: 20px;">ì €ì¥ëœ ë¬¸ì¥</h2>
                    <div id="itemList"></div>
                </div>

                <!-- í…ŒìŠ¤íŠ¸ íƒ­ -->
                <div id="test" class="tab-content">
                    <h2 style="margin-bottom: 20px;">ë¹ˆì¹¸ í…ŒìŠ¤íŠ¸</h2>
                    <div id="testArea"></div>
                </div>

                <!-- í•™ìŠµê¸°ë¡ íƒ­ -->
                <div id="stats" class="tab-content">
                    <h2 style="margin-bottom: 20px;">í•™ìŠµ í†µê³„</h2>
                    <div id="statsArea"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer onload="gapiLoaded()"></script>
    
    <script>
        // ====================================
        // êµ¬ê¸€ API ì„¤ì •
        // ====================================
        
        // TODO: ì—¬ê¸°ì— ì—¬ëŸ¬ë¶„ì˜ êµ¬ê¸€ í´ë¼ì´ì–¸íŠ¸ IDì™€ API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”
        const CLIENT_ID = '226062573368-mjq0aqjlmb3neprksu9q0kfmvc5b52ut.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyCwMbMGY0YWjLqaecCCdtce_cpOBGVuSlU';
        
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/drive.appdata';

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let accessToken = null;
        let fileId = null;

        // ====================================
        // ë°ì´í„° ì €ì¥ì†Œ
        // ====================================
        let items = [];
        let stats = {
            total: 0,
            correct: 0,
            incorrect: 0
        };
        let currentTestIndex = 0;

        // ====================================
        // êµ¬ê¸€ API ì´ˆê¸°í™”
        // ====================================
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            try {
                await gapi.client.init({
                    apiKey: API_KEY,
                    discoveryDocs: [DISCOVERY_DOC],
                });
                gapiInited = true;
                maybeEnableButtons();
            } catch(err) {
                console.error('GAPI ì´ˆê¸°í™” ì‹¤íŒ¨:', err);
                alert('êµ¬ê¸€ API ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. API í‚¤ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
            }
        }

        function gisLoaded() {
            try {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: '', // ë‚˜ì¤‘ì— ì„¤ì •
                });
                gisInited = true;
                maybeEnableButtons();
            } catch(err) {
                console.error('GIS ì´ˆê¸°í™” ì‹¤íŒ¨:', err);
                alert('êµ¬ê¸€ ë¡œê·¸ì¸ ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í´ë¼ì´ì–¸íŠ¸ IDë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
            }
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                const loginButton = document.getElementById('loginButton');
                loginButton.disabled = false;
                loginButton.innerHTML = `
                    <svg width="18" height="18" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd"><path d="M17.6 9.2l-.1-1.8H9v3.4h4.8C13.6 12 13 13 12 13.6v2.2h3a8.8 8.8 0 0 0 2.6-6.6z" fill="#4285F4"/><path d="M9 18c2.4 0 4.5-.8 6-2.2l-3-2.2a5.4 5.4 0 0 1-8-2.9H1V13a9 9 0 0 0 8 5z" fill="#34A853"/><path d="M4 10.7a5.4 5.4 0 0 1 0-3.4V5H1a9 9 0 0 0 0 8l3-2.3z" fill="#FBBC05"/><path d="M9 3.6c1.3 0 2.5.4 3.4 1.3L15 2.3A9 9 0 0 0 1 5l3 2.4a5.4 5.4 0 0 1 5-3.7z" fill="#EA4335"/></g></svg>
                    êµ¬ê¸€ë¡œ ë¡œê·¸ì¸
                `;
                console.log('êµ¬ê¸€ API ì´ˆê¸°í™” ì™„ë£Œ');
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ GIS ë¡œë“œ (ìŠ¤í¬ë¦½íŠ¸ê°€ ë¹„ë™ê¸°ë¡œ ë¡œë“œë˜ë¯€ë¡œ)
        window.addEventListener('load', function() {
            // gsi clientê°€ ë¡œë“œë  ë•Œê¹Œì§€ ëŒ€ê¸°
            const checkGIS = setInterval(function() {
                if (typeof google !== 'undefined' && google.accounts && google.accounts.oauth2) {
                    clearInterval(checkGIS);
                    gisLoaded();
                }
            }, 100);
        });

        // ====================================
        // ì¸ì¦ ì²˜ë¦¬
        // ====================================
        function handleAuthClick() {
            if (CLIENT_ID === 'YOUR_CLIENT_ID_HERE.apps.googleusercontent.com') {
                alert('ë¨¼ì € êµ¬ê¸€ í´ë¼ì´ì–¸íŠ¸ IDì™€ API í‚¤ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”!\n\nì„¤ì • ë°©ë²•ì€ í•¨ê»˜ ì œê³µëœ SETUP_GUIDE.txt íŒŒì¼ì„ ì°¸ê³ í•˜ì„¸ìš”.');
                return;
            }

            if (!gapiInited || !gisInited) {
                alert('êµ¬ê¸€ APIê°€ ì•„ì§ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (!tokenClient) {
                alert('ë¡œê·¸ì¸ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì‹¤íŒ¨. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
                return;
            }

            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    console.error('ë¡œê·¸ì¸ ì—ëŸ¬:', resp);
                    alert('ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + resp.error);
                    return;
                }
                accessToken = gapi.client.getToken().access_token;
                await onSignIn();
            };

            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        async function onSignIn() {
            updateSyncStatus('syncing', 'ë™ê¸°í™” ì¤‘...');
            
            try {
                // ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const userInfo = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                    headers: {
                        Authorization: `Bearer ${accessToken}`
                    }
                }).then(r => r.json());

                document.getElementById('userName').textContent = userInfo.name;
                document.getElementById('userAvatar').src = userInfo.picture;

                // êµ¬ê¸€ ë“œë¼ì´ë¸Œì—ì„œ ë°ì´í„° ë¡œë“œ
                await loadFromDrive();

                // UI ì „í™˜
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';

                updateSyncStatus('online', 'ë™ê¸°í™” ì™„ë£Œ');
                renderList();
            } catch(err) {
                console.error('ë¡œê·¸ì¸ í›„ ì²˜ë¦¬ ì‹¤íŒ¨:', err);
                alert('ë¡œê·¸ì¸ì€ ì„±ê³µí–ˆì§€ë§Œ ë°ì´í„° ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                updateSyncStatus('offline', 'ì˜¤í”„ë¼ì¸');
            }
        }

        function handleSignoutClick() {
            if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                const token = gapi.client.getToken();
                if (token !== null) {
                    google.accounts.oauth2.revoke(token.access_token);
                    gapi.client.setToken('');
                }
                
                accessToken = null;
                fileId = null;
                items = [];
                stats = { total: 0, correct: 0, incorrect: 0 };

                document.getElementById('loginScreen').style.display = 'block';
                document.getElementById('mainApp').style.display = 'none';
                updateSyncStatus('offline', 'ì˜¤í”„ë¼ì¸');
            }
        }

        // ====================================
        // êµ¬ê¸€ ë“œë¼ì´ë¸Œ ë™ê¸°í™”
        // ====================================
        async function loadFromDrive() {
            try {
                // appDataFolderì—ì„œ íŒŒì¼ ì°¾ê¸°
                const response = await gapi.client.drive.files.list({
                    spaces: 'appDataFolder',
                    fields: 'files(id, name)',
                    q: "name='vocab_data.json'"
                });

                const files = response.result.files;
                
                if (files && files.length > 0) {
                    fileId = files[0].id;
                    
                    // íŒŒì¼ ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
                    const fileResponse = await gapi.client.drive.files.get({
                        fileId: fileId,
                        alt: 'media'
                    });

                    const data = JSON.parse(fileResponse.body);
                    items = data.items || [];
                    stats = data.stats || { total: 0, correct: 0, incorrect: 0 };
                } else {
                    // íŒŒì¼ì´ ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
                    await saveToDrive();
                }
            } catch (err) {
                console.error('ë“œë¼ì´ë¸Œ ë¡œë“œ ì‹¤íŒ¨:', err);
                alert('êµ¬ê¸€ ë“œë¼ì´ë¸Œì—ì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        async function saveToDrive() {
            try {
                updateSyncStatus('syncing', 'ì €ì¥ ì¤‘...');

                const data = {
                    items: items,
                    stats: stats,
                    lastUpdated: new Date().toISOString()
                };

                const content = JSON.stringify(data);
                const blob = new Blob([content], { type: 'application/json' });

                const metadata = {
                    name: 'vocab_data.json',
                    mimeType: 'application/json',
                    parents: ['appDataFolder']
                };

                const formData = new FormData();
                formData.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                formData.append('file', blob);

                let url = 'https://www.googleapis.com/upload/drive/v3/files';
                let method = 'POST';

                if (fileId) {
                    url = `https://www.googleapis.com/upload/drive/v3/files/${fileId}`;
                    method = 'PATCH';
                }

                const response = await fetch(`${url}?uploadType=multipart`, {
                    method: method,
                    headers: {
                        Authorization: `Bearer ${accessToken}`
                    },
                    body: formData
                });

                const result = await response.json();
                if (!fileId) {
                    fileId = result.id;
                }

                updateSyncStatus('online', 'ë™ê¸°í™” ì™„ë£Œ');
            } catch (err) {
                console.error('ë“œë¼ì´ë¸Œ ì €ì¥ ì‹¤íŒ¨:', err);
                updateSyncStatus('offline', 'ì €ì¥ ì‹¤íŒ¨');
                alert('êµ¬ê¸€ ë“œë¼ì´ë¸Œì— ì €ì¥í•˜ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        function updateSyncStatus(status, text) {
            const indicator = document.querySelector('.sync-indicator');
            const syncText = document.getElementById('syncText');
            
            indicator.className = 'sync-indicator ' + status;
            syncText.textContent = text;
        }

        // ====================================
        // UI ê¸°ëŠ¥ë“¤
        // ====================================
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');

            if (tabName === 'list') {
                renderList();
            } else if (tabName === 'test') {
                startTest();
            } else if (tabName === 'stats') {
                renderStats();
            }
        }

        async function addItem(event) {
            event.preventDefault();
            
            const item = {
                id: Date.now(),
                sentence: document.getElementById('sentence').value.trim(),
                word: document.getElementById('word').value.trim(),
                sentenceMeaning: document.getElementById('sentenceMeaning').value.trim(),
                wordMeaning: document.getElementById('wordMeaning').value.trim(),
                createdAt: new Date().toISOString()
            };

            items.push(item);
            await saveToDrive();

            document.getElementById('sentence').value = '';
            document.getElementById('word').value = '';
            document.getElementById('sentenceMeaning').value = '';
            document.getElementById('wordMeaning').value = '';

            alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }

        function renderList() {
            const listContainer = document.getElementById('itemList');
            
            if (items.length === 0) {
                listContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“</div>
                        <p>ì•„ì§ ì €ì¥ëœ ë¬¸ì¥ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                        <p style="font-size: 14px; margin-top: 10px;">ì¶”ê°€í•˜ê¸° íƒ­ì—ì„œ ë¬¸ì¥ì„ ì €ì¥í•´ë³´ì„¸ìš”!</p>
                    </div>
                `;
                return;
            }

            listContainer.innerHTML = items.map(item => `
                <div class="item">
                    <div class="item-sentence">${item.sentence}</div>
                    <span class="item-word">${item.word}</span>
                    <div class="item-actions">
                        <button class="btn btn-secondary btn-small" onclick="deleteItem(${item.id})">ì‚­ì œ</button>
                    </div>
                </div>
            `).join('');
        }

        async function deleteItem(id) {
            if (confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                items = items.filter(item => item.id !== id);
                await saveToDrive();
                renderList();
            }
        }

        function startTest() {
            const testArea = document.getElementById('testArea');
            
            if (items.length === 0) {
                testArea.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">âœï¸</div>
                        <p>í…ŒìŠ¤íŠ¸í•  ë¬¸ì¥ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                        <p style="font-size: 14px; margin-top: 10px;">ë¨¼ì € ë¬¸ì¥ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”!</p>
                    </div>
                `;
                return;
            }

            currentTestIndex = 0;
            renderTest();
        }

        function renderTest() {
            const testArea = document.getElementById('testArea');
            const item = items[currentTestIndex];
            
            const regex = new RegExp(`\\b${item.word}\\b`, 'gi');
            const sentenceWithBlank = item.sentence.replace(regex, '<span class="blank">______</span>');

            testArea.innerHTML = `
                <div class="test-card">
                    <div class="test-sentence">${sentenceWithBlank}</div>
                    <div class="form-group">
                        <label>ë‹µ ì…ë ¥</label>
                        <input type="text" id="answerInput" class="answer-input" placeholder="ë‹¨ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”" autofocus>
                    </div>
                    <button class="btn" onclick="checkAnswer()">ì •ë‹µ í™•ì¸</button>
                    <div id="result"></div>
                </div>
                <div class="test-navigation">
                    <div class="test-progress">${currentTestIndex + 1} / ${items.length}</div>
                    <div>
                        ${currentTestIndex > 0 ? '<button class="btn btn-secondary btn-small" onclick="previousTest()">ì´ì „</button>' : ''}
                        ${currentTestIndex < items.length - 1 ? '<button class="btn btn-secondary btn-small" onclick="nextTest()" style="margin-left: 8px;">ë‹¤ìŒ</button>' : ''}
                    </div>
                </div>
            `;

            document.getElementById('answerInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    checkAnswer();
                }
            });
        }

        async function checkAnswer() {
            const item = items[currentTestIndex];
            const userAnswer = document.getElementById('answerInput').value.trim();
            const resultDiv = document.getElementById('result');

            if (!userAnswer) {
                alert('ë‹µì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }

            const isCorrect = userAnswer.toLowerCase() === item.word.toLowerCase();

            stats.total++;
            if (isCorrect) {
                stats.correct++;
            } else {
                stats.incorrect++;
            }
            await saveToDrive();

            resultDiv.innerHTML = `
                <div class="result ${isCorrect ? 'correct' : 'incorrect'}">
                    <div class="result-title">${isCorrect ? 'âœ… ì •ë‹µì…ë‹ˆë‹¤!' : 'âŒ í‹€ë ¸ìŠµë‹ˆë‹¤'}</div>
                    ${!isCorrect ? `<div style="margin-bottom: 10px; color: #333;">ì •ë‹µ: <strong>${item.word}</strong></div>` : ''}
                    <div class="meaning">
                        <div class="meaning-label">ğŸ“„ ë¬¸ì¥ ëœ»</div>
                        <div class="meaning-text">${item.sentenceMeaning}</div>
                    </div>
                    <div class="meaning">
                        <div class="meaning-label">ğŸ’¡ ë‹¨ì–´ ëœ»</div>
                        <div class="meaning-text">${item.word} = ${item.wordMeaning}</div>
                    </div>
                </div>
            `;

            document.getElementById('answerInput').disabled = true;
        }

        function previousTest() {
            if (currentTestIndex > 0) {
                currentTestIndex--;
                renderTest();
            }
        }

        function nextTest() {
            if (currentTestIndex < items.length - 1) {
                currentTestIndex++;
                renderTest();
            }
        }

        function renderStats() {
            const statsArea = document.getElementById('statsArea');
            const accuracy = stats.total > 0 ? Math.round((stats.correct / stats.total) * 100) : 0;

            statsArea.innerHTML = `
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number">${items.length}</div>
                        <div class="stat-label">ì €ì¥ëœ ë¬¸ì¥</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.total}</div>
                        <div class="stat-label">ì´ ì‹œë„</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.correct}</div>
                        <div class="stat-label">ì •ë‹µ</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.incorrect}</div>
                        <div class="stat-label">ì˜¤ë‹µ</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${accuracy}%</div>
                        <div class="stat-label">ì •ë‹µë¥ </div>
                    </div>
                </div>
                <button class="btn btn-secondary" onclick="resetStats()">í†µê³„ ì´ˆê¸°í™”</button>
            `;
        }

        async function resetStats() {
            if (confirm('í†µê³„ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                stats = { total: 0, correct: 0, incorrect: 0 };
                await saveToDrive();
                renderStats();
            }
        }
    </script>
</body>
</html>
